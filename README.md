### Goal
Bypass firmware signature check that prevents tplink deco devices from loading user-provided firmware (i.e. openwrt)
in a way that doesn't require soldering on a serial console

### Vulnerability
- In tplink deco firmware, a modification was made to uboot to add http upload functionality to support
firmware installation directly from the bootloader as a failsafe procedure
- This modification introduced an unconstrained sscanf reading the "fw-type" field
from the user-provided firmware file into a fixed 256-byte stack buffer

### Exploit
- Take control of PC by overflowing stack buffer enough to overwrite return address
- Point new return address to location within user-submitted firmware file to run arbitrary shellcode
 
### Shellcode
Developed to load a boot image via tftp and execute it from RAM, as if following commands were run from a uboot prompt:
```
setenv serverip 192.168.0.2
setenv ipaddr 192.168.0.1
tftpboot 0x81000000 initramfs-kernel.bin
bootm 0x81000000
```
- [v1_static](v1_static): initial version with hardcoded symbol addresses (now deprecated). required reverse engineering a dump of each individual device/versions bootloader to locate symbol addresses
- [v2_dynamic](v2_dynamic): second version which dynamically searches RAM for required symbols addresses

### Possible Applicable Devices
[According to tplink](https://community.tp-link.com/us/home/kb/detail/490), uboot http recovery is present on the following devices:
- Deco E4
- Deco M4
- Deco P9
- Deco M9 Plus
- Deco X20/X60 V1 (firmware 1.2.5 or later version)
- Deco X20 V1.2 and later version
- Deco X60 V2 and later
- Deco S4

but these devices come in different "versions" which may have completely different hardware and uboot

### Devices With Confirmed Working Exploit
- [Deco S4 v2](https://github.com/naf419/tplink_deco_exploits/releases/download/v1/deco_all_webfailsafe_faux_fw_tftp.bin)
- [Deco S4 v2.6](https://github.com/naf419/tplink_deco_exploits/releases/download/v1/deco_all_webfailsafe_faux_fw_tftp.bin)
- [Deco M4R v1](https://github.com/naf419/tplink_deco_exploits/releases/download/v1/deco_all_webfailsafe_faux_fw_tftp.bin)
- [Deco M4R v2](https://github.com/naf419/tplink_deco_exploits/releases/download/v1/deco_m4rv2_faux_fw_tftp.bin)
- [Deco P9 v1.80](https://github.com/naf419/tplink_deco_exploits/releases/download/v1/deco_all_webfailsafe_faux_fw_tftp.bin)
- [Deco P9 v2.0](https://github.com/naf419/tplink_deco_exploits/releases/download/v1/deco_all_webfailsafe_faux_fw_tftp.bin)
- Expecting others should work with [dynamic version](https://github.com/naf419/tplink_deco_exploits/releases/download/v1/deco_all_webfailsafe_faux_fw_tftp.bin), [let me know](mailto:naf@sdf.org) if you have tested it with another device/version

## Devices that will *not* work with exploit
- Deco S4 v3.6 (ARM board)
